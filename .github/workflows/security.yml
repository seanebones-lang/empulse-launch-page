name: Security & Secrets Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Weekly security scan
    - cron: '0 2 * * 1'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  dependency-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Frontend dependency scanning
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level moderate || true

      - name: Run OWASP Dependency Check (Frontend)
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'EmPulse-Frontend'
          path: './'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --nvdValidForHours 24

      # Backend dependency scanning
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Safety (Python security scanner)
        working-directory: ./backend
        run: |
          pip install safety
          safety check || true

      - name: Run Bandit (Python security linter)
        working-directory: ./backend
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true

  code-security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  container-security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # This would run if you had Docker containers
      # For Railway deployments, Railway handles container security
      - name: Note on container security
        run: |
          echo "â„¹ï¸ Container security scanning:"
          echo "- Railway handles container builds and basic security"
          echo "- For advanced scanning, consider Trivy or Snyk Container"
          echo "- Railway's base images are regularly updated"

  compliance-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required security files
        run: |
          # Check for security.md or similar
          if [ ! -f "SECURITY.md" ]; then
            echo "âš ï¸ SECURITY.md file missing"
          fi

          # Check for license file
          if [ ! -f "LICENSE" ]; then
            echo "âš ï¸ LICENSE file missing"
          else
            echo "âœ… LICENSE file present"
          fi

      - name: Environment variable security check
        run: |
          echo "ðŸ” Checking for secure environment variable usage..."

          # Check for hardcoded secrets in code
          if grep -r "XAI_API_KEY\|password\|secret" --include="*.ts" --include="*.tsx" --include="*.py" . | grep -v "os.getenv\|process.env\|secrets."; then
            echo "âš ï¸ Potential hardcoded secrets found"
            exit 1
          else
            echo "âœ… No hardcoded secrets detected"
          fi

  generate-security-report:
    needs: [secrets-scan, dependency-scan, code-security-scan, compliance-check]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate security summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" > security-report.md
          echo "" >> security-report.md
          echo "**Date:** $(date)" >> security-report.md
          echo "**Commit:** ${{ github.sha }}" >> security-report.md
          echo "**Branch:** ${{ github.ref }}" >> security-report.md
          echo "" >> security-report.md

          # Check job statuses
          if [ "${{ needs.secrets-scan.result }}" == "success" ]; then
            echo "âœ… Secrets Scan: PASSED" >> security-report.md
          else
            echo "âŒ Secrets Scan: FAILED" >> security-report.md
          fi

          if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
            echo "âœ… Dependency Scan: PASSED" >> security-report.md
          else
            echo "âŒ Dependency Scan: FAILED" >> security-report.md
          fi

          if [ "${{ needs.code-security-scan.result }}" == "success" ]; then
            echo "âœ… Code Security Scan: PASSED" >> security-report.md
          else
            echo "âŒ Code Security Scan: FAILED" >> security-report.md
          fi

          if [ "${{ needs.compliance-check.result }}" == "success" ]; then
            echo "âœ… Compliance Check: PASSED" >> security-report.md
          else
            echo "âŒ Compliance Check: FAILED" >> security-report.md
          fi

          echo "" >> security-report.md
          echo "### Recommendations:" >> security-report.md
          echo "- Regularly update dependencies" >> security-report.md
          echo "- Rotate API keys quarterly" >> security-report.md
          echo "- Monitor Railway security advisories" >> security-report.md
          echo "- Review CodeQL alerts weekly" >> security-report.md

          cat security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md

      - name: Alert on security failures
        if: needs.secrets-scan.result == 'failure' || needs.dependency-scan.result == 'failure' || needs.code-security-scan.result == 'failure'
        run: |
          echo "ðŸš¨ Security scan failures detected!"
          # Additional alerting logic would go here